#!/bin/bash

#
# Git pre-commit hook for amgctl
#
# This hook runs linting and formatting checks for the amgctl project
# before allowing commits to proceed.
#

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ” Running pre-commit checks for amgctl...${NC}"

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
AMGCTL_DIR="$REPO_ROOT/tools/amgctl"

# Check if we're committing changes to the amgctl directory
if ! git diff --cached --name-only | grep -q "^tools/amgctl/"; then
    echo -e "${GREEN}âœ… No amgctl changes detected, skipping linting checks.${NC}"
    exit 0
fi

echo -e "${BLUE}ğŸ“ Detected changes in amgctl directory${NC}"

# Check if amgctl directory exists
if [ ! -d "$AMGCTL_DIR" ]; then
    echo -e "${RED}âŒ amgctl directory not found at $AMGCTL_DIR${NC}"
    exit 1
fi

# Check if Makefile exists
if [ ! -f "$AMGCTL_DIR/Makefile" ]; then
    echo -e "${RED}âŒ Makefile not found in $AMGCTL_DIR${NC}"
    exit 1
fi

# Change to amgctl directory
cd "$AMGCTL_DIR"

echo -e "${BLUE}ğŸ“ Changed to amgctl directory: $(pwd)${NC}"

# Function to run a command and handle errors
run_check() {
    local check_name="$1"
    local command="$2"
    
    echo -e "${YELLOW}Running $check_name...${NC}"
    
    if eval "$command"; then
        echo -e "${GREEN}âœ… $check_name passed${NC}"
        return 0
    else
        echo -e "${RED}âŒ $check_name failed${NC}"
        return 1
    fi
}

# Track if any checks failed
FAILED=0

# Run formatting check
if ! run_check "formatting check" "make fmt-check"; then
    echo -e "${YELLOW}ğŸ’¡ Tip: Run 'make fmt' or 'make fix' to auto-format your code${NC}"
    FAILED=1
fi

# Run go vet
if ! run_check "go vet" "make vet"; then
    FAILED=1
fi

# Install golangci-lint if needed (silently)
if ! make lint-install > /dev/null 2>&1; then
    echo -e "${YELLOW}âš ï¸ Warning: Could not install golangci-lint${NC}"
fi

# Run golangci-lint
if ! run_check "golangci-lint" "make lint"; then
    echo -e "${YELLOW}ğŸ’¡ Tip: Run 'make fix' to auto-fix some linting issues${NC}"
    FAILED=1
fi

# Summary
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}ğŸ‰ All pre-commit checks passed! Proceeding with commit.${NC}"
    exit 0
else
    echo -e "${RED}ğŸ’¥ Pre-commit checks failed!${NC}"
    echo -e "${YELLOW}ğŸ“‹ To fix issues:${NC}"
    echo -e "  ${YELLOW}â€¢ Run: ${NC}cd $AMGCTL_DIR && make fix"
    echo -e "  ${YELLOW}â€¢ Or run individual commands: ${NC}make fmt, make vet, make lint"
    echo -e "  ${YELLOW}â€¢ Then stage your changes and commit again${NC}"
    echo -e "${YELLOW}ğŸš« To skip these checks (not recommended): ${NC}git commit --no-verify"
    exit 1
fi
